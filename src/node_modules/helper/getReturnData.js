const ethers = require('ethers')

module.exports = getReturnData

function getReturnData (opts) {
  var iface = new ethers.utils.Interface(opts.solcMetadata.output.abi)
  var fun = opts.contract.interface.functions[opts.fnName]
  var txReturn
  var ifaceTypes

  if (opts.tag === 'transaction') {
    ifaceTypes =  fun.inputs
    var tx = { data: opts.data }
    txReturn = iface.parseTransaction(tx).args
  }
  else if (opts.tag === 'call') {
    ifaceTypes =  fun.outputs
    txReturn = opts.transaction
  }

  var decodedData = decodeReturnData(txReturn, ifaceTypes)
  return decodedData
}

function decodeReturnData (txReturn, txTypes) {
  if (Array.isArray(txReturn)) {  // recursive case
    return txReturn.map((x, i) => decodeReturnData(x, getTypes(txTypes, i)))
  } else { // atomic case
    return decode(txReturn, getTypes(txTypes, 0))
  }
}

function decode (txReturn, txType) {
  var type = txType.type
  if (type.includes('int')) return Number(txReturn.toString())
  else return txReturn
}

function getTypes(types, i) {
  if (types.components) return types.components
  if (Array.isArray(types) && types[i].type) return types[i]
  return types
}
